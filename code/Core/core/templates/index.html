<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}"/>
    <script type="text/javascript" src="{% static 'd3.v3.js' %}"></script>
    <title>SOK Tim3</title>
</head>
<body>
<div class="wrapper">
    <nav class="border-frame">
        <div class="logo">
            <h1>Team3 Graph Visualizator</h1>
        </div>

        <div class="selections">
            <form id="parameters-form">
                {% csrf_token %}
                <div class="selections-row">
                    <select id="visualizator-selection" name="visualization">
                        <option value="default">select visualizator</option>
                        {% for visualizator in visualizators %}
                            <option value="{{ visualizator.name }}">{{ visualizator.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="selections-row">
                    <h2>parse and visualize graph from file:</h2>
                    <select id="parser-selection" name="parser">
                        <option value="default">select parser</option>
                        {% for parser in parsers %}
                            <option value="{{ parser.name }}">{{ parser.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="file" id="file-selection" name="file">
                    <button id="parse-file-button" type="button">Parse file</button>
                </div>
                <div class="selections-row">
                    <h2>load existing graph:</h2>
                    <select id="graph-selection" name="graph">
                        <option value="default">select graph</option>
                        {% for graph in loaded_graphs %}
                            <option value="{{ graph.name }}">{{ graph.name }}</option>
                        {% endfor %}
                    </select>
                    <button id="load-graph-button" type="button">Load graph</button>
                </div>
            </form>
        </div>
    </nav>

    <div class="upper">
        <div class="tree-view border-frame">
            {#                 ovde ide svg za tree view#}
        </div>

        <div class="main-visual border-frame" id="main-div">
            {% if rendered_graph %}
                {{ rendered_graph|safe }}
            {% endif %}
        </div>
    </div>

    <div class="lower">
        <div class="bird-view border-frame">
            <svg id="bird-svg"></svg>
        </div>

        <div class="search-and-details border-frame">
            <div class="search"></div>
            <div class="details"></div>
        </div>
    </div>





    <script>

        // Get the CSRF token from the cookie
        function getCookie(name) {
            const cookieValue = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return cookieValue ? cookieValue.pop() : '';
        }

        const csrftoken = getCookie('csrftoken');

        // Add event listeners to the buttons
        const parseButton = document.getElementById('parse-file-button');
        parseButton.addEventListener('click', () => {
            event.preventDefault();
            // Get the selected values
            const visualizatorSelection = document.getElementById('visualizator-selection').value;
            const parserSelection = document.getElementById('parser-selection').value;
            const fileSelection = document.getElementById('file-selection').files[0]; // Assuming you want to upload a single file

            // Create a FormData object to send the data
            const formData = new FormData();
            formData.append('visualization', visualizatorSelection);
            formData.append('parser', parserSelection);
            formData.append('file', fileSelection);

            // Send a POST request to the desired URL
            fetch('/parse_and_visualize', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                body: formData,
            })
                .then(response => {
                    // Handle the response as needed
                    window.location.href = '/parse_and_visualize';
                    console.log(response);
                })
                .catch(error => {
                    // Handle any errors
                    console.error(error);
                });
        });

        const loadButton = document.getElementById('load-graph-button');
        loadButton.addEventListener('click', () => {
            event.preventDefault();
            // Get the selected values
            const visualizatorSelection = document.getElementById('visualizator-selection').value;
            const graphSelection = document.getElementById('graph-selection').value;

            // Create a FormData object to send the data
            const formData = new FormData();
            formData.append('visualization', visualizatorSelection);
            formData.append('graph', graphSelection);

            // Send a POST request to the desired URL
            fetch('/load_and_visualize', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                body: formData,
            })
                .then(response => {
                    // Handle the response as needed
                    window.location.href = '/load_and_visualize';
                    console.log(response);

                })
                .catch(error => {
                    // Handle any errors
                    console.error(error);
                });
        });

</script>


<script>
  // Add the bird view functionality

  // Bird view dimensions
  var birdViewWidth = 200;
  var birdViewHeight = 150;

  // Create SVG for the bird view
  var birdViewSVG = d3.select(".bird-view")
    .select("svg")
    .attr("width", birdViewWidth)
    .attr("height", birdViewHeight);

  // Create a group (g) element for the bird view links
  var birdViewLinks = birdViewSVG.append("g");

  // Create a group (g) element for the bird view nodes
  var birdViewNodes = birdViewSVG.append("g");

  // Clone nodes from the main visual graph
  var cloneNodes = nodes.map(function (d) {
    return {
      id: d.id,
      name: d.name,
      x: d.x,
      y: d.y,
      color: "#5DADE2", // Set the color to blue
    };
  });

  // Update the position and size of the bird view nodes
  birdViewNodes
    .selectAll("circle")
    .data(cloneNodes)
    .enter()
    .append("circle")
    .attr("cx", function (d) {
      return d.x;
    })
    .attr("cy", function (d) {
      return d.y;
    })
    .attr("r", function (d) {
      return Math.max(20, d.name.length * 3);
    })
    .style("fill", function (d) {
      return d.color;
    });

  // Clone links from the main visual graph
  var cloneLinks = links.map(function (d) {
    var sourceNode = cloneNodes.find(function (node) {
      return node.id === d.source.id;
    });
    var targetNode = cloneNodes.find(function (node) {
      return node.id === d.target.id;
    });

    return {
      source: sourceNode,
      target: targetNode,
    };
  });

  // Update the position of the bird view links
  birdViewLinks
    .selectAll("line")
    .data(cloneLinks)
    .enter()
    .append("line")
    .attr("x1", function (d) {
      return d.source.x;
    })
    .attr("y1", function (d) {
      return d.source.y;
    })
    .attr("x2", function (d) {
      return d.target.x;
    })
    .attr("y2", function (d) {
      return d.target.y;
    })
    .style("stroke", "#888") // Set the stroke color to gray
    .style("stroke-width", 2); // Set the stroke width

  // Disable panning and zooming in bird view
  birdViewSVG.call(
    d3.zoom()
      .on("zoom", null)
      .scaleExtent([1, 1])
  );

  // Create node labels in the bird view
  birdViewNodes
    .selectAll("text")
    .data(cloneNodes)
    .enter()
    .append("text")
    .attr("x", function (d) {
      return d.x;
    })
    .attr("y", function (d) {
      return d.y;
    })
    .attr("dy", "0.35em")
    .attr("text-anchor", "middle")
    .attr("fill", "black")
    .attr("font-size", "12px")
    .text(function (d) {
      return d.name;
    });

  // Adjust the position of the group (g) elements to match the SVG dimensions
  birdViewLinks.attr("transform", "translate(0,0)");
  birdViewNodes.attr("transform", "translate(0,0)");

</script>



</div>
</body>
</html>
